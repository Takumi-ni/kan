<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KanziPlus</title>
<style>
  :root{
    --bg:#151a22;--card:#1b2029;--ink:#e9eaee;--muted:#b2b6bf;--accent:#f8d27a;--accent-2:#ffb455;--ok:#22c55e;--bad:#ef4444;--line:#2f3542;--pink-soft:#1f1a12;
    --radius:18px;--shadow:0 18px 40px rgba(0,0,0,.30);
  }
  *{box-sizing:border-box}
  html, body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;background:radial-gradient(1200px 600px at 20% -10%, #1b2029 0%, rgba(27,32,41,0) 60%),linear-gradient(180deg,#151a22 0%, #0f131a 100%);color:var(--ink);font-size:17px;line-height:1.6}
  header{position:sticky;top:0;z-index:20;background:rgba(21,26,34,.55);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid #232938}
  .wrap{max-width:420px;margin:0 auto;padding:16px}
  .brand{font-weight:900;letter-spacing:.8px;color:#ffe8a3;font-size:26px;text-align:center;text-shadow:0 2px 8px rgba(248,210,122,.25)}
  .tabs{display:flex;gap:18px;margin-top:10px;justify-content:center}
  .tab{appearance:none;border:none;background:transparent;padding:12px 18px;font-weight:700;color:var(--muted);cursor:pointer;position:relative;font-size:16px}
  .tab.active{color:var(--ink)}
  .tab.active:after{content:"";position:absolute;left:12px;right:12px;bottom:-1px;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:3px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr}
  .card{background:var(--card);box-shadow:var(--shadow);border-radius:var(--radius);padding:16px;border:1px solid #262c39}
  .card-pink{background:linear-gradient(180deg, rgba(255,220,140,.06), rgba(255,220,140,.04));border:1px solid rgba(255,220,140,.18)}
  .card h3{margin:0 0 10px 0;font-size:18px}
  label{font-size:14px;color:var(--muted)}
  input[type="text"],input[type="number"],select{width:100%;padding:12px 12px;border:1px solid #343a48;border-radius:12px;background:#12161e;color:var(--ink);font-size:16px}
  input[type="number"]{text-align:right}
  .row{display:flex;gap:10px;align-items:center}
  .row > *{flex:1}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#271b05;font-weight:800;cursor:pointer;box-shadow:0 10px 26px rgba(255,180,85,.22)}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .btn.bad{background:var(--bad)}
  .btn.ok{background:var(--ok)}
  .btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#2a1b04}
  .btn.outline-pink{background:transparent;color:var(--accent);border:1.75px solid var(--accent);box-shadow:none}
  .btn.light-pink{background:#F0FFF7;color:#0b604a;border:1px solid #CFEFE3;box-shadow:none}
  .btn.lock-on{background:#e5e7eb;color:#374151;border:1px solid #d1d5db}
  .btn.lock-off{background:#fde68a;color:#7a5d00;border:1px solid #fcd34d}
  .toolbar{display:flex;gap:10px;flex-wrap:nowrap}
  .pill{padding:10px 18px;border:1px solid #343a48;border-radius:999px;background:#12161e;cursor:pointer;color:var(--muted);font-weight:700;flex:1;text-align:center}
  .pill.active{border-color:var(--accent);color:#ffe8a3;background:rgba(248,210,122,.10)}
  .muted{color:var(--muted)}
  .group-row{display:grid;grid-template-columns:1.6fr .7fr auto;gap:10px;align-items:center;margin-top:10px}
  .group-row .del{width:40px}
  .mini{font-size:13px;color:var(--muted)}
  hr.sep{border:none;border-top:1px dashed var(--line);margin:12px 0}
  .bars{display:flex;gap:8px;align-items:flex-end;justify-content:center;height:140px;padding:4px 2px;margin-top:14px}
  .bar{width:12px;border-radius:10px;box-shadow:inset 0 -4px 8px rgba(0,0,0,.08)}
  .hint{font-size:12px;color:var(--muted)}
  .money{font-variant-numeric:tabular-nums}
  .stack{display:flex;flex-direction:column;gap:8px}
  .controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .sumline{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#181e28;border:1px solid #343a48}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  .result-card{background:#1e1a12;border:1px solid rgba(255,220,140,.18)}
  .k-table{width:100%;border-collapse:collapse}
  .k-table td{padding:6px 0;border-bottom:1px solid #343a48}
  /* Night beer garden extras */
  header .wrap{position:relative}
  .brand-icon{font-size:28px; margin:0 8px; filter:drop-shadow(0 2px 6px rgba(248,210,122,.35))}
  .sky{position:absolute; inset:0; pointer-events:none}
  .star{position:absolute; width:3px; height:3px; background:#ffe8a3; border-radius:50%; opacity:.85; animation:twinkle 3s ease-in-out infinite}
  @keyframes twinkle{ 0%,100%{opacity:.4; transform:scale(.9)} 50%{opacity:1; transform:scale(1)} }
  /* Hide number input spinners (direct input only) */
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  input[type="number"]{ -moz-appearance:textfield; }
  /* Bigger amount number inside shortage line */
  .big-num{ font-size:24px; }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand"><span class="brand-icon" aria-hidden="true">ğŸº</span>KanziPlus<span class="brand-icon" aria-hidden="true">âœ¨</span></div>
      <div class="sky" aria-hidden="true">
        <span class="star" style="top:6px;left:6%;width:4px;height:4px"></span>
        <span class="star" style="top:18px;left:20%;width:3px;height:3px"></span>
        <span class="star" style="top:10px;left:64%;width:5px;height:5px"></span>
        <span class="star" style="top:26px;left:82%;width:3px;height:3px"></span>
        <span class="star" style="top:30px;left:38%;width:4px;height:4px"></span>
        <span class="star" style="top:14px;left:50%;width:6px;height:6px"></span>
        <span class="star" style="top:4px;left:90%;width:5px;height:5px"></span>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="input">æƒ…å ±å…¥åŠ›</button>
        <button class="tab" data-tab="assign">å‰²ã‚ŠæŒ¯ã‚Š</button>
        <button class="tab" data-tab="result">çµæœå‡ºåŠ›</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:14px;padding-bottom:120px;">
    <!-- æƒ…å ±å…¥åŠ› TAB -->
    <section id="tab-input" class="grid two">
      <div class="card">
        <h3>ãŠä¼šè¨ˆã®ç·é¡ã‚’å…¥åŠ›</h3>
        <div class="row">
          <input id="totalInput" type="number" min="0" step="1" value="10000"/>
          <div class="mini">å††</div>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1;">
        <h3>ãŠæ”¯æ‰•ã„ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›</h3>
        <div id="groupsArea"></div>
        <div class="mini" style="margin-top:10px;margin-bottom:6px;">ä¸Šã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å¤šãæ‰•ã„ã¾ã™</div>
        <div class="row" style="margin-top:0">
          <button id="addGroup" class="btn outline-pink" style="width:100%">ï¼‹ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ </button>
        </div>
      </div>

      <!-- å‰²ã‚Šå‹˜ãƒãƒ©ãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="grid-column:1 / -1;">
        <h3>ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®å‰²ã‚Šå‹˜ãƒãƒ©ãƒ³ã‚¹</h3>
        <div class="toolbar" id="balanceBtns">
          <button class="pill" data-balance="large">å¤§ãã„</button>
          <button class="pill active" data-balance="medium">æ™®é€š</button>
          <button class="pill" data-balance="small">å°ã•ã„</button>
        </div>
        <div class="bars" id="bars"></div>
      </div>

      <!-- ç«¯æ•°ã®æ‰±ã„ã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="grid-column:1 / -1;">
        <h3>ç«¯æ•°ã®æ‰±ã„ã‚’ã©ã†ã™ã‚‹ï¼Ÿ</h3>
        <div class="toolbar" id="modeBtns">
          <button class="pill active" data-mode="payMore">èª°ã‹ãŒå¤šãæ‰•ã†</button>
          <button class="pill" data-mode="payLess">èª°ã‹ã‚’å®‰ãã™ã‚‹</button>
        </div>
      </div>

      <!-- æ¬¡ã¸é€²ã‚€ï¼ˆåˆ†é›¢ï¼‰ -->
      <div style="grid-column:1 / -1;" class="row">
        <button class="btn accent" onclick="goTab('assign')" style="width:100%">ã¤ãã¸é€²ã‚€</button>
      </div>
    </section>

    <!-- å‰²ã‚ŠæŒ¯ã‚Š TAB -->
    <section id="tab-assign" style="display:none" class="grid">
      <div class="card">
        <h3 style="margin-bottom:4px">æ”¯æ‰•ã„ã®é‡‘é¡ã‚’èª¿æ•´ã™ã‚‹</h3>
        <div class="mini">ï¼ˆ1äººã‚ãŸã‚Šã®é‡‘é¡ã‚’100å††å˜ä½ã§èª¿æ•´ã™ã‚‹ï¼‰</div>
        <div id="adjustArea" class="stack"></div>
        <div class="plain-sum" style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
          <div>åˆè¨ˆï¼ˆç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆï¼‰</div>
          <div><b id="sumRounded" class="money"></b> å††</div>
        </div>
      </div>

      <div class="card">
        <h3>ç«¯æ•°ã®å‰²ã‚ŠæŒ¯ã‚Š</h3>
        <div id="shortageLine" class="money" style="margin-bottom:8px"></div>
        <div id="manualList" class="stack"></div>
        <div class="row" style="margin-top:6px">
          <button id="addPerson" class="btn outline-pink" style="width:100%">ï¼‹ äººã‚’è¿½åŠ </button>
        </div>
      </div>

      <!-- æ¬¡ã¸é€²ã‚€ï¼ˆåˆ†é›¢ï¼‰ -->
      <div style="grid-column:1 / -1;" class="row">
        <button class="btn accent" onclick="goTab('result')" style="width:100%">ã¤ãã¸é€²ã‚€</button>
      </div>
    </section>

    <!-- çµæœå‡ºåŠ› TAB -->
    <section id="tab-result" style="display:none" class="grid">
      <div class="card result-card">
        <h3>çµæœ</h3>
        <div id="resultView" class="stack"></div>
        <div class="sumline" style="margin-top:10px">
          <div class="muted">ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š</div>
          <div id="deltaLine" class="money"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn outline-pink" id="copyBtn" style="width:100%">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <div class="card">
        <h3>è¨ˆç®—è©³ç´°</h3>
        <div id="detailView" class="stack"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
// ======= STATE =======
const state = {
  total: 10000,
  mode: 'payMore', // payMore: floor to 100; payLess: ceil to 100
  balance: 'medium',
  groups: [
    {id: uid(), name: 'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people: 1, perPerson: 0, fixed:false},
    {id: uid(), name: 'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people: 2, perPerson: 0, fixed:false},
    {id: uid(), name: 'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people: 3, perPerson: 0, fixed:false},
  ],
  manual: [], // {id, groupId, name, amount}
  manualDraft: [], // UIç”¨ã®ä¸‹æ›¸ãï¼ˆã¤ãã¸é€²ã‚€ã§ç¢ºå®šï¼‰
  shortage: 0 // +ä¸è¶³, -è¶…é
}

// ======= UTIL =======
function uid(){ return Math.random().toString(36).slice(2,9) }
function yen(n){ return (Math.round(n)).toLocaleString('ja-JP') }
function round100(x, dir){ const m = Math.floor(x/100)*100; if(dir==='down') return m; if(dir==='up') return (x%100===0)? x : m+100; return Math.round(x/100)*100 }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600) }

// ======= TABS =======
const tabBtns = document.querySelectorAll('.tab');
for(const b of tabBtns){ b.addEventListener('click',()=>goTab(b.dataset.tab)) }
function commitManualAndRebalance(){
  // ä¸‹æ›¸ãã‚’æœ¬æ¡ç”¨ã—ã€æœ€æ–°ã®ç«¯æ•°ã‚’åŸºæº–ã«æ‰‹å‹•å‰²ã‚ŠæŒ¯ã‚Šã‚’åæ˜ â†’è‡ªå‹•å†é…åˆ†
  state.manual = JSON.parse(JSON.stringify(state.manualDraft||[]));
  // å¿µã®ãŸã‚ã€ç¾åœ¨ã®ç«¯æ•°ï¼ˆç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆãƒ™ãƒ¼ã‚¹ï¼‰ã‚’å†è¨ˆç®—ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
  state.shortage = state.total - groupsRoundedSum();
  tryRebalanceManual(-1); // æ‰‹å‹•å‰²ã‚ŠæŒ¯ã‚Šã‚’è€ƒæ…®ã—ã¦ãƒ¢ãƒ¼ãƒ‰ç¶­æŒã§Â±100/äººãƒ©ã‚¦ãƒ³ãƒ‰é…åˆ†
}

function goTab(key){
  if(key==='result'){
    commitManualAndRebalance();
  }
  document.querySelectorAll('section[id^=tab-]').forEach(s=>s.style.display='none');
  const sec = document.getElementById('tab-'+key);
  if(sec) sec.style.display='grid';
  tabBtns.forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
  renderAll();
}

// ======= INPUT: GROUPS UI =======
const groupsArea = document.getElementById('groupsArea');
const addGroupBtn = document.getElementById('addGroup');
addGroupBtn.addEventListener('click',()=>{
  state.groups.push({id:uid(), name:`ã‚°ãƒ«ãƒ¼ãƒ—${state.groups.length+1}`, people:1, perPerson:0, fixed:false});
  recompute(); renderAll();
});

function renderGroupsEditor(){
  groupsArea.innerHTML = '';
  state.groups.forEach((g,idx)=>{
    const row = document.createElement('div');
    row.className='group-row';
    row.innerHTML = `
      <input type="text" value="${g.name}" data-k="name" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å"/>
      <select data-k="people">${Array.from({length:99},(_,i)=>`<option ${g.people===(i+1)?'selected':''} value="${i+1}">${i+1}äºº</option>`).join('')}</select>
      <button class="btn small ghost del">Ã—</button>`;
    row.querySelector('[data-k=name]').addEventListener('input',e=>{ g.name=e.target.value; });
    row.querySelector('[data-k=name]').addEventListener('blur',()=>{ renderAll(); });
    row.querySelector('[data-k=people]').addEventListener('change',e=>{ g.people=parseInt(e.target.value); recompute(); renderAll() });
    row.querySelector('.del').addEventListener('click',()=>{ if(state.groups.length<=1){ toast('ã‚°ãƒ«ãƒ¼ãƒ—ã¯æœ€ä½1ã¤å¿…è¦ã§ã™'); return } state.groups.splice(idx,1); recompute(); renderAll(); });
    groupsArea.appendChild(row);
  });
}

// ======= INPUT: TOTAL & MODE & BALANCE =======
const totalInput = document.getElementById('totalInput');
const balanceBtns = document.getElementById('balanceBtns');
const modeBtns = document.getElementById('modeBtns');

totalInput.addEventListener('input',()=>{ state.total= Number(totalInput.value||0); recompute(); renderAll(); });
;['large','medium','small'].forEach(x=>{
  const p = balanceBtns.querySelector(`[data-balance=${x}]`);
  p.addEventListener('click',()=>{ balanceBtns.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); state.balance=x; recompute(); renderAll(); })
});
;['payMore','payLess'].forEach(m=>{
  const b = modeBtns.querySelector(`[data-mode=${m}]`);
  b.addEventListener('click',()=>{ modeBtns.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.mode=m; recompute(); renderAll(); })
});

// ======= BALANCE BARS =======
function weightsByBalance(n){
  if(state.balance==='large'){ return Array.from({length:n},(_,i)=> (n-i)); } 
  else if(state.balance==='small'){ const base=1; const step=0.1; return Array.from({length:n},(_,i)=> base + step*(n-1-i)); } 
  else { const base=1; const step=0.3; return Array.from({length:n},(_,i)=> base + step*(n-1-i)); }
}
function renderBars(ws){
  const bars = document.getElementById('bars');
  const max = Math.max(...ws,1);
  bars.innerHTML = ws.map((w,i)=>{
    const h = 30 + (w/max)*88; // 30..118 vertical (ç¸¦é•·/å…¨ä½“ã¯å°ã•ã‚)
    const colors = ['#D4AF37','#C0C0C0','#CD7F32'];
    const color = i<3 ? colors[i] : '#d1d5db';
    return `<div class=\"bar\" title=\"é‡ã¿ ${w.toFixed(2)}\" style=\"height:${h}px;background:${color}\"></div>`
  }).join('');
}

// ======= CORE CALC =======
function recompute(){
  const ws = weightsByBalance(state.groups.length);
  const denom = state.groups.reduce((acc,g,idx)=> acc + g.people*ws[idx], 0);
  const X = denom>0 ? state.total/denom : 0;
  state.groups.forEach((g,idx)=>{
    const raw = ws[idx]*X; g.raw = raw;
    g.perPerson = (state.mode==='payMore') ? round100(raw,'down') : round100(raw,'up');
  });
  state.shortage = state.total - groupsRoundedSum(); // +ä¸è¶³ / -è¶…é
}
function groupsRoundedSum(){ return state.groups.reduce((s,g)=> s + g.perPerson * g.people, 0); }

function clickAdjust(idx, step){
  if(step===0) return; const unit=100; const times=Math.abs(step)/unit; const sign=Math.sign(step);
  for(let t=0;t<times;t++){
    const g = state.groups[idx];
    const deltaSum = sign*unit*g.people; // ã“ã®ã‚°ãƒ«ãƒ¼ãƒ—ã®åˆè¨ˆå¤‰åŒ–
    // ã¾ãšåæ˜ ï¼ˆã‚¯ãƒªãƒƒã‚¯ã¯å¸¸ã«é€šã™ï¼‰
    g.perPerson += sign*unit;
    state.shortage -= deltaSum; // ä¸è¶³(+)ï¼è¶…é(-)

    if(state.mode==='payMore'){
      if(!autoDistribute(idx, -unit)){
        g.perPerson -= sign*unit; state.shortage += deltaSum; toast('å‰²ã‚ŠæŒ¯ã‚Šå…ˆãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå›ºå®šã®è§£é™¤ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰'); break;
      }
    }else{ // payLess
      if(!autoDistribute(idx, +unit)){
        g.perPerson -= sign*unit; state.shortage += deltaSum; toast('å‰²ã‚ŠæŒ¯ã‚Šå…ˆãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆå›ºå®šã®è§£é™¤ã‚’ã”ç¢ºèªãã ã•ã„ï¼‰'); break;
      }
    }
  }
  renderAll();
}

// eachDelta: å—ã‘å–ã‚Šå´ã‚°ãƒ«ãƒ¼ãƒ—ã® 1äººã‚ãŸã‚Šã«åŠ ãˆã‚‹å·®åˆ†ï¼ˆpayMoreæ™‚ã¯ -100ã€payLessæ™‚ã¯ +100ï¼‰
function autoDistribute(excludeIdx, eachDelta, useManual=false){
  const unit=100; let safety=2000; // å¿µã®ãŸã‚ã®ç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–
  const needsAdjustPayMore = () => (useManual ? (state.shortage - manualEffect()) < 0 : state.shortage < 0);
  const needsAdjustPayLess = () => (useManual ? (state.shortage - manualEffect()) > 0 : state.shortage > 0);
  while( (state.mode==='payMore' && needsAdjustPayMore()) || (state.mode==='payLess' && needsAdjustPayLess()) ){
    let recipientIdx = []; let personCount = 0;
    for(let i=0;i<state.groups.length;i++){
      const g = state.groups[i];
      if(g.fixed) continue; // å›ºå®šã¯å¯¾è±¡å¤–
      if(eachDelta<0 && g.perPerson<=0) continue; // 0å††æœªæº€NG
      recipientIdx.push(i); personCount += g.people; // æ“ä½œã‚°ãƒ«ãƒ¼ãƒ—ã‚‚å›ºå®šã§ãªã‘ã‚Œã°å«ã‚€
    }
    if(personCount===0) return false; // åˆ†é…ä¸èƒ½

    // 1ãƒ©ã‚¦ãƒ³ãƒ‰: éå›ºå®šãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ã« eachDeltaï¼ˆÂ±100/äººï¼‰
    recipientIdx.forEach(i=>{ const gg=state.groups[i]; if(!(eachDelta<0 && gg.perPerson<=0)) gg.perPerson += eachDelta; });
    const deltaSum = eachDelta * personCount; // sum å¤‰åŒ–é‡ â†’ shortage ã¯ -deltaSum
    state.shortage -= deltaSum;

    if(--safety<=0) break;
  }
  return true;
}

// manual rebalance helper (for individual assignments)
function groupIdxById(id){ return state.groups.findIndex(g=>g.id===id); }
function tryRebalanceManual(excludeIdx){
  let safety=2000;
  while( ((state.mode==='payMore') && (state.shortage - manualEffect()) < 0) || ((state.mode==='payLess') && (state.shortage - manualEffect()) > 0) ){
    const ok = autoDistribute(excludeIdx, state.mode==='payMore' ? -100 : +100, true);
    if(!ok) return false;
    if(--safety<=0) break;
  }
  return true;
}

// ======= ASSIGN TAB RENDER =======
// äº‹å‰ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šmanualDraft ã‚’åæ˜ ã—ã€ãƒ¢ãƒ¼ãƒ‰ç¶­æŒã®ãŸã‚ã«Â±100/äººã®ãƒ©ã‚¦ãƒ³ãƒ‰é…åˆ†ã‚’ä»®é©ç”¨
function computePreview(opts={includeFixedInPreview:true}){
  const draft = state.manualDraft || [];
  const draftSum = draft.reduce((acc,m)=> acc + (Number(m.amount)||0), 0);
  // ç¾åœ¨ã® perPerson ã‚’ã‚³ãƒ”ãƒ¼
  const per = state.groups.map(g=> g.perPerson);
  // æ‰‹å‹•é©ç”¨å¾Œã®æ®‹é‡ï¼ˆ+ä¸è¶³ / -è¶…éï¼‰
  let remain = state.shortage - (state.mode==='payMore' ? draftSum : -draftSum);
  let safety = 2000;
  // ç«¯æ•°ã‚µã‚¤ãƒ³ç¶­æŒã®ãŸã‚ã€Â±100/äºº ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ä»®é©ç”¨
  while( (state.mode==='payMore' && remain < 0) || (state.mode==='payLess' && remain > 0) ){
    let idx = []; let cnt = 0;
    for(let i=0;i<state.groups.length;i++){
      const g = state.groups[i];
      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ includeFixedInPreview=true ã®ã¨ãå›ºå®šã‚‚å¯¾è±¡ã«ã™ã‚‹
      if(!opts.includeFixedInPreview && g.fixed) continue;
      if(state.mode==='payMore' && per[i]<=0) continue; // 0å††æœªæº€é˜²æ­¢
      idx.push(i); cnt += g.people;
    }
    if(cnt===0) break; // ã“ã‚Œä»¥ä¸Šèª¿æ•´ã§ããªã„
    const eachDelta = (state.mode==='payMore')? -100 : +100;
    idx.forEach(i=>{ per[i] += eachDelta; });
    // shortage ã¯åˆè¨ˆå¤‰åŒ– eachDelta*cnt ã‚’åæ˜ ï¼ˆtotal - sumï¼‰
    remain -= eachDelta * cnt;
    if(--safety<=0) break;
  }
  const sumPreview = per.reduce((s,p,i)=> s + p*state.groups[i].people, 0); // ç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆï¼ˆæ‰‹å‹•é‡‘é¡ã¯å«ã‚ãªã„ï¼‰
  return { per, remain, sumPreview, draftSum };
}

const adjustArea = document.getElementById('adjustArea');
const sumRoundedEl = document.getElementById('sumRounded');
const shortageLine = document.getElementById('shortageLine');

function renderAssign(){
  adjustArea.innerHTML='';
  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å€¤ï¼ˆmanualDraftã«åŸºã¥ãä»®é©ç”¨ï¼‰â€»å…¥åŠ›ä»•æ§˜ã¯ç¶­æŒã™ã‚‹ãŸã‚ã€å…¥åŠ›ä¸­ã¯updateShortagePreview()ã§å†æç”»ã—ãªã„
  const hasDraft = (state.manualDraft||[]).length>0 && (state.manualDraft||[]).some(m=>Number(m.amount)>0);
  const preview = computePreview();

  state.groups.forEach((g,idx)=>{
    const row = document.createElement('div');
    row.className='card card-pink';
    const lockCls = g.fixed ? 'btn small lock-on' : 'btn small lock-off';
    const displayPer = hasDraft ? preview.per[idx] : g.perPerson;
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style=\"font-weight:800\">${g.name}<\/div>
          <div class=\"mini muted\">${g.people}äºº<\/div>
        </div>
        <div style="text-align:right">
          <div style="font-size:22px;font-weight:800" class=\"money\">${yen(displayPer)}å††<span class=\"mini\">/1äºº<\/span><\/div>
          <button class="${lockCls}" style="margin-top:6px">${g.fixed?'ğŸ”’ å›ºå®šä¸­':'ğŸ”“ å›ºå®šãªã—'}</button>
        </div>
      </div>
      <div class="controls-grid">
        <button class="btn small outline-pink" data-d="+100">ï¼‹100</button>
        <button class="btn small outline-pink" data-d="-100">âˆ’100</button>
        <button class="btn small outline-pink" data-d="+1000">ï¼‹1000</button>
        <button class="btn small outline-pink" data-d="-1000">âˆ’1000</button>
      </div>`;
    row.querySelectorAll('button[data-d]').forEach(b=> b.addEventListener('click',()=>{ clickAdjust(idx, parseInt(b.dataset.d,10)); }));
    row.querySelector('.'+(g.fixed?'lock-on':'lock-off')).addEventListener('click',()=>{ g.fixed=!g.fixed; renderAll(); });
    adjustArea.appendChild(row);
  });

  // åˆè¨ˆï¼ˆç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆï¼‰ã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã® per ã‚’åæ˜ ï¼ˆæ‰‹å‹•ã®é‡‘é¡ã¯å«ã‚ãªã„ï¼‰
  const sumForView = hasDraft ? preview.sumPreview : groupsRoundedSum();
  sumRoundedEl.textContent = yen(sumForView);

  // æ®‹ã‚Šè¡¨ç¤ºï¼šãƒ¢ãƒ¼ãƒ‰ã®æ–‡è¨€ã¯å›ºå®šã—ã¤ã¤ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ®‹é‡ã‚’æ¡ç”¨ï¼ˆâ€»å…¥åŠ›ä¸­ã®å†æç”»ã¯è¡Œã‚ãªã„ï¼‰
  const remain = hasDraft ? preview.remain : state.shortage;
  const absRemain = Math.abs(remain);
  const suffix = hasDraft && ((state.mode==='payMore' && remain<0) || (state.mode==='payLess' && remain>0)) ? '<span class="mini muted">ï¼ˆå›ºå®šã®è§£é™¤ãŒå¿…è¦ï¼‰</span>' : '';
  shortageLine.innerHTML = absRemain===0
    ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
    : (state.mode==='payMore'
        ? `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain)}</b> å†† è¶³ã‚Šãªã„ ${suffix}`
        : `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain)}</b> å†† å¤šã„ ${suffix}`);

  renderManualList();
}

function updateShortagePreview(){
  // å…¥åŠ›ä¸­ã§ã‚‚ã€å…¥åŠ›æ¬„ã‚’å£Šã•ãšã«æ•°å€¤ã ã‘ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
  const hasDraft = (state.manualDraft||[]).some(m=>Number(m.amount)>0);
  if(!hasDraft){
    sumRoundedEl.textContent = yen(groupsRoundedSum());
    const absRemain0 = Math.abs(state.shortage);
    shortageLine.innerHTML = absRemain0===0
      ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
      : (state.mode==='payMore'
          ? `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain0)}</b> å†† è¶³ã‚Šãªã„`
          : `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain0)}</b> å†† å¤šã„`);
    return;
  }
  // ç›´å‰ã®â€œè‰¯ã‹ã£ãŸä»•æ§˜â€ã«åˆã‚ã›ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯å›ºå®šã‚‚å«ã‚ã¦ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ˆ=ç·äººæ•°ãƒ™ãƒ¼ã‚¹ï¼‰
  const preview = computePreview({includeFixedInPreview:true});
  // èª¿æ•´å¾Œ per ã‚’ã‚«ãƒ¼ãƒ‰ã®è¡¨ç¤ºã ã‘å·®ã—æ›¿ãˆï¼ˆå…¥åŠ›æ¬„ã¯å†æç”»ã—ãªã„ï¼‰
  const cards = adjustArea.querySelectorAll('.card.card-pink');
  cards.forEach((card, i)=>{
    const moneyEl = card.querySelector('.money');
    if(moneyEl && preview.per[i] != null){ moneyEl.innerHTML = yen(preview.per[i]) + 'å††<span class=\"mini\">/1äºº<\/span>'; }
  });
  // åˆè¨ˆï¼ˆç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆï¼‰
  sumRoundedEl.textContent = yen(preview.sumPreview);
  // æ®‹ã‚Šè¡¨ç¤ºï¼ˆæ–‡è¨€ã¯å›ºå®šï¼‰
  const absRemain = Math.abs(preview.remain);
  const suffix = ((state.mode==='payMore' && preview.remain<0) || (state.mode==='payLess' && preview.remain>0)) ? '<span class="mini muted">ï¼ˆå›ºå®šã®è§£é™¤ãŒå¿…è¦ï¼‰</span>' : '';
  shortageLine.innerHTML = absRemain===0
    ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
    : (state.mode==='payMore'
        ? `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain)}</b> å†† è¶³ã‚Šãªã„ ${suffix}`
        : `ãŠä¼šè¨ˆé‡‘é¡ <b class="money">${yen(state.total)}</b> å††ã¾ã§ã€æ®‹ã‚Š <b class=\"money big-num\">${yen(absRemain)}</b> å†† å¤šã„ ${suffix}`);
}

// ======= MANUAL ASSIGN =======
const manualList = document.getElementById('manualList');
const addPersonBtn = document.getElementById('addPerson');
addPersonBtn.addEventListener('click',()=>{
  if(state.groups.length===0) return;
  state.manualDraft.push({id:uid(), groupId:state.groups[0].id, name:'', amount:0});
  renderManualList();
  updateShortagePreview();
});

function renderManualList(){
  manualList.innerHTML='';
  const tail = state.mode==='payMore' ? 'å†† å¤šãæ‰•ã†' : 'å†† å®‰ãã™ã‚‹';
  (state.manualDraft||[]).forEach((m,i)=>{
    const box = document.createElement('div');
    box.className='card card-pink';
    const options = state.groups.map(g=>`<option value="${g.id}" ${g.id===m.groupId?'selected':''}>${g.name}</option>`).join('');
    box.innerHTML = `
      <div class="row" style="gap:8px">
        <select class="gsel">${options}</select>
        <input class="name" type="text" placeholder="ãŠåå‰" value="${m.name}"/>
      </div>
      <div class="row" style="margin-top:8px">
        <input class="amt" type="number" min="0" step="1" inputmode="numeric" value="${m.amount}"/>
        <div class="mini" style="flex:none">${tail}</div>
        <button class="btn small ghost" style="flex:none">Ã—</button>
      </div>`;

    // ä¸‹æ›¸ãã ã‘ã‚’ç·¨é›†ï¼ˆæ®‹ã‚Šé‡‘é¡ã¯å¤‰ãˆãªã„ï¼‰
    box.querySelector('.gsel').addEventListener('change',e=>{ m.groupId = e.target.value; updateShortagePreview(); renderManualList(); });
    box.querySelector('.name').addEventListener('input',e=>{ m.name = e.target.value; updateShortagePreview(); });
    box.querySelector('.amt').addEventListener('input',e=>{ m.amount = Number(e.target.value||0); updateShortagePreview(); });

    box.querySelector('button').addEventListener('click',()=>{ state.manualDraft.splice(i,1); renderManualList(); updateShortagePreview(); });

    manualList.appendChild(box);
  });
}

function manualEffect(){
  const s = state.manual.reduce((acc,m)=> acc + (m.amount||0), 0);
  return (state.mode==='payMore') ? s : -s; // payMore: shortage - s, payLess: shortage + s
}

// ======= RESULT RENDER =======
const resultView = document.getElementById('resultView');
const deltaLine = document.getElementById('deltaLine');
const detailView = document.getElementById('detailView');

function updateResults(){
  resultView.innerHTML=''; detailView.innerHTML='';
  const manualByGroup = {}; state.groups.forEach(g=> manualByGroup[g.id]=[]);
  state.manual.forEach(m=>{ if(manualByGroup[m.groupId]) manualByGroup[m.groupId].push({name:m.name||'ï¼ˆåå‰æœªå…¥åŠ›ï¼‰', amount:m.amount||0}); });

  let sum = 0;
  state.groups.forEach(g=>{
    const groupTotal = g.perPerson * g.people;
    const manualSum = manualByGroup[g.id].reduce((a,x)=>a+x.amount,0) * (state.mode==='payMore'? 1 : -1);
    sum += groupTotal + manualSum;

    const section = document.createElement('div');
    section.className='card card-pink';
    const unit = `<span class="mini">1äººã‚ãŸã‚Š</span> <b class="money">${yen(g.perPerson)}</b>å††`;

    let peopleBlock = '';
    if(manualByGroup[g.id].length>0){
      peopleBlock = manualByGroup[g.id].map(x=>{
        const adj = (state.mode==='payMore'? '+' : 'âˆ’') + yen(x.amount);
        const val = state.mode==='payMore'? (g.perPerson + x.amount) : (g.perPerson - x.amount);
        return `<div class="row" style="justify-content:space-between"><div>ãƒ»${x.name} <span class=\"mini\">(${adj}å††)</span></div><div class=\"money\">${yen(val)}å††</div></div>`
      }).join('');
      const others = g.people - manualByGroup[g.id].length;
      if(others>0){
        peopleBlock += `<div class=\"row\" style=\"justify-content:space-between\"><div>ãƒ»ä»–ãƒ¡ãƒ³ãƒãƒ¼ <span class=\"mini\">(+0å††)</span></div><div class=\"money\">${yen(g.perPerson)}å††</div></div>`
      }
    }

    section.innerHTML = `<div style="font-weight:800">${g.name} <span style="margin-left:10px">${unit}</span></div>${peopleBlock ? `<div class=\"stack\" style=\"margin-top:6px\">${peopleBlock}</div>`:''}`;
    resultView.appendChild(section);

    // details block
    const d = document.createElement('div');
    let lines = `<table class="k-table">`+
      `<tr><td>${g.name}</td><td class="money" style="text-align:right">${yen(g.perPerson)}å†† Ã— ${g.people}äºº = ${yen(groupTotal)}å††</td></tr>`;
    manualByGroup[g.id].forEach(x=>{ const sign = state.mode==='payMore'? '+' : 'âˆ’'; lines += `<tr><td>${x.name}</td><td class="money" style="text-align:right">${sign}${yen(x.amount)}å††</td></tr>` });
    lines += `</table>`; d.innerHTML = lines; detailView.appendChild(d);
  });

  const delta = sum - state.total; // +å¤šã„ / -è¶³ã‚Šãªã„
  if(delta===0){ deltaLine.innerHTML = `<b class="ok">å·®é¡ 0 å††ï¼ˆãƒ”ãƒƒã‚¿ãƒªï¼‰</b>`; }
  else if(delta>0){ deltaLine.innerHTML = `<span class="money">${yen(Math.abs(delta))}</span> å†† <b>å¤šã„</b>`; }
  else { deltaLine.innerHTML = `<span class="money">${yen(Math.abs(delta))}</span> å†† <b>è¶³ã‚Šãªã„</b>`; }

  // details summaryï¼ˆåŒã˜ã‚«ãƒ¼ãƒ‰å†…ã«åˆç®—ã‚’è¡¨ç¤ºï¼‰
  const totals = document.createElement('div');
  totals.innerHTML = `
    <hr class="sep"/>
    <table class="k-table">
      <tr><td>åˆè¨ˆ</td><td class="money" style="text-align:right">${yen(sum)}å††</td></tr>
      <tr><td>ãŠä¼šè¨ˆé‡‘é¡</td><td class="money" style="text-align:right">${yen(state.total)}å††</td></tr>
      <tr><td>å·®é¡</td><td class="money" style="text-align:right">${delta>0? '+' : ''}${yen(delta)}å††</td></tr>
    </table>`;
  detailView.appendChild(totals);

  window.__copyText = buildCopyText(sum, delta);
}

function buildCopyText(sum, delta){
  let t = `ã€KanziPlus è¨ˆç®—çµæœã€‘\nåˆè¨ˆ: ${yen(state.total)} å††\n`;
  state.groups.forEach(g=>{ t += `ãƒ»${g.name}: 1äººã‚ãŸã‚Š ${yen(g.perPerson)}å†† Ã— ${g.people}äºº\n`; });
  t += `åˆè¨ˆ(${yen(sum)}å††) / å·®é¡(${delta})`;
  return t;
}

// ======= COPY =======
document.getElementById('copyBtn').addEventListener('click',async()=>{
  try{ await navigator.clipboard.writeText(window.__copyText||''); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch(e){ toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
});

// ======= RENDER ALL =======
function renderAll(){
  totalInput.value = state.total;
  renderGroupsEditor(); const ws = weightsByBalance(state.groups.length); renderBars(ws);
  if(state.groups.every(g=>!g.perPerson)) recompute();
  renderAssign(); updateResults();
}

// ======= TESTS =======
function runTests(){
  const snapshot = JSON.stringify(state);
  try{
    // 1) payMore ã®ã¨ãã¯åˆè¨ˆãŒç·é¡ä»¥ä¸‹
    state.mode='payMore'; recompute();
    console.assert(groupsRoundedSum() <= state.total, 'payMore: åˆè¨ˆãŒç·é¡ã‚’è¶…ãˆãªã„ã¯ãš');

    // 2) payLess ã®ã¨ãã¯åˆè¨ˆãŒç·é¡ä»¥ä¸Š
    state.mode='payLess'; recompute();
    console.assert(groupsRoundedSum() >= state.total, 'payLess: åˆè¨ˆãŒç·é¡ä»¥ä¸Šã«ãªã‚‹ã¯ãš');

    // 3) çµæœæç”»ãŒè¡Œã‚ã‚Œã‚‹
    updateResults();
    console.assert(document.getElementById('resultView').children.length >= 1, 'çµæœãƒ“ãƒ¥ãƒ¼ãŒæç”»ã•ã‚Œã‚‹');

    // 4) ç«¯æ•°221ä¸è¶³ â†’ èª²é•·+100ã‚’2å›ã§è‡ªå‹•é…åˆ†ãŒèµ°ã‚Šã€ãƒ¢ãƒ¼ãƒ‰ã‚’ç¶­æŒï¼ˆæ“ä½œã‚°ãƒ«ãƒ¼ãƒ—ã‚‚å—ã‘å–ã‚Šå¯¾è±¡ï¼‰
    (function(){
      state.mode='payMore';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:12000, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:9800, fixed:false},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:7500, fixed:false}
      ];
      state.total = 54321;
      state.manual = []; state.manualDraft=[];
      state.shortage = state.total - groupsRoundedSum();
      console.assert(state.shortage === 221, 'å‰æ: ç«¯æ•°221ä¸è¶³');
      clickAdjust(1, +100); // èª²é•· +100
      console.assert(state.shortage === 21, '1å›ç›®+100å¾Œ: 21ä¸è¶³');
      clickAdjust(1, +100); // èª²é•· ã•ã‚‰ã«+100 â†’ è‡ªå‹•é…åˆ†
      console.assert(state.shortage === 421, '2å›ç›®+100å¾Œ: 421ä¸è¶³ï¼ˆæ“ä½œã‚°ãƒ«ãƒ¼ãƒ—ã‚‚å—ã‘å–ã‚Šï¼‰');
      console.assert(state.groups[1].perPerson === 9900, 'èª²é•· 1äººã‚ãŸã‚Š: æœ€çµ‚ 9900');
      console.assert(state.groups[0].perPerson === 11900 && state.groups[2].perPerson === 7400, 'éƒ¨é•·/ä¸€èˆ¬: å„ âˆ’100 åæ˜ ');
    })();

    // 5) payMore ç¶­æŒãƒ†ã‚¹ãƒˆï¼šè¤‡æ•°å›æ“ä½œã—ã¦ã‚‚ä¸è¶³ãŒè² ã«ãªã‚‰ãªã„
    (function(){
      state.mode='payMore';
      recompute();
      for(let i=0;i<5;i++){ clickAdjust(0, +100); }
      console.assert(state.shortage >= 0, 'payMoreç¶­æŒ: ä¸è¶³>=0 ã®ã¾ã¾');
    })();

    // 6) payLess ç¶­æŒãƒ†ã‚¹ãƒˆï¼šè¤‡æ•°å›æ“ä½œã—ã¦ã‚‚è¶…éãŒæ­£ã«ãªã‚‰ãªã„
    (function(){
      state.mode='payLess';
      recompute();
      for(let i=0;i<5;i++){ clickAdjust(0, -100); }
      console.assert(state.shortage <= 0, 'payLessç¶­æŒ: è¶…é<=0 ã®ã¾ã¾');
    })();

    // 7) manual: payMoreã§å€‹åˆ¥æŒ‡å®šã—ã¦ã‚‚ä¸è¶³>=0ã‚’ç¶­æŒã—ã€æ–‡è¨€ã¯ã€Œè¶³ã‚Šãªã„ã€
    (function(){
      state.mode='payMore';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:12000, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:9800, fixed:false},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:7500, fixed:false}
      ];
      state.total = 54321; state.manual = []; state.manualDraft=[];
      state.shortage = state.total - groupsRoundedSum();
      console.assert(state.shortage === 221, 'å‰æ: ç«¯æ•°221ä¸è¶³');
      state.manual.push({id:uid(), groupId: state.groups[0].id, name:'ãŸãã¿', amount:300});
      const ok = tryRebalanceManual(0);
      console.assert(ok, 'manualé…åˆ†: payMoreã§æˆåŠŸ');
      updateResults();
      const remain = state.shortage - manualEffect();
      console.assert(remain >= 0, 'payMore: æ‰‹å‹•å¾Œã‚‚ä¸è¶³>=0');
      console.assert(shortageLine.innerHTML.includes('è¶³ã‚Šãªã„'), 'æ–‡è¨€: è¶³ã‚Šãªã„å›ºå®š');
    })();

    // 8) manual: payLessã§å€‹åˆ¥æŒ‡å®šã—ã¦ã‚‚è¶…é<=0ã‚’ç¶­æŒã—ã€æ–‡è¨€ã¯ã€Œå¤šã„ã€
    (function(){
      state.mode='payLess';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:12100, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:9900, fixed:false},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:7600, fixed:false}
      ];
      state.total = 54321; state.manual = []; state.manualDraft=[];
      state.shortage = state.total - groupsRoundedSum();
      console.assert(state.shortage <= 0, 'å‰æ: payLessã§è¶…é<=0');
      state.manual.push({id:uid(), groupId: state.groups[0].id, name:'ã¿ã', amount:300});
      const ok2 = tryRebalanceManual(0);
      console.assert(ok2, 'manualé…åˆ†: payLessã§æˆåŠŸ');
      updateResults();
      const remain2 = state.shortage - manualEffect();
      console.assert(remain2 <= 0, 'payLess: æ‰‹å‹•å¾Œã‚‚è¶…é<=0');
      console.assert(shortageLine.innerHTML.includes('å¤šã„'), 'æ–‡è¨€: å¤šã„å›ºå®š');
    })();

    // 9) manualå…·ä½“ä¾‹ï¼šä¸è¶³300ã§ Aã•ã‚“+350ï¼ˆpayMoreï¼‰ã€‚èª²é•·ã¯å›ºå®šã€Aã•ã‚“ã¯ä¸€èˆ¬æ‰€å±ã¨ã—ã¦ï¼ˆç›´æ¥manualï¼‰
    (function(){
      state.mode='payMore';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:2200, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:1800, fixed:true},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:1300, fixed:false}
      ];
      state.total = 10000; // åˆè¨ˆ 9700 â†’ ä¸è¶³ 300
      state.manual = []; state.manualDraft=[];
      state.shortage = state.total - groupsRoundedSum();
      console.assert(state.shortage === 300, 'å‰æ: 10000ã¾ã§300ä¸è¶³');
      const generalId = state.groups[2].id;
      state.manual.push({id:uid(), groupId: generalId, name:'Aã•ã‚“', amount:350});
      const ok3 = tryRebalanceManual(2);
      console.assert(ok3, 'manualé…åˆ†: æˆåŠŸ');
      // è¿”é‡‘1ãƒ©ã‚¦ãƒ³ãƒ‰ã§ éƒ¨é•·/ä¸€èˆ¬ ã®åŸºæº–å˜ä¾¡ãŒâˆ’100
      console.assert(state.groups[0].perPerson === 2100, 'éƒ¨é•·: 2100ã«æ¸›é¡');
      console.assert(state.groups[2].perPerson === 1200, 'ä¸€èˆ¬: 1200ã«æ¸›é¡');
      // è¡¨ç¤ºä¸Šã¯ä¸è¶³ãŒæ­£ï¼ˆãƒ¢ãƒ¼ãƒ‰ç¶­æŒï¼‰ã€‚ç†è«–ä¸Šã®æ®‹ã‚Šã¯ 300-350+400=350ä¸è¶³
      const remain3 = state.shortage - manualEffect();
      console.assert(remain3 >= 0, 'ä¸è¶³>=0ã‚’ç¶­æŒ');
    })();

    // 10) UIãƒ•ãƒ­ãƒ¼ã®å†ç¾ï¼šmanualDraft ã«å…¥åŠ›â†’çµæœã‚¿ãƒ–ã§ç¢ºå®šâ†’è‡ªå‹•å†é…åˆ†ãŒèµ°ã‚‹
    (function(){
      state.mode='payMore';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:2200, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:1800, fixed:true},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:1300, fixed:false}
      ];
      state.total = 10000; // 9700 â†’ 300ä¸è¶³
      state.manual = []; state.manualDraft=[{id:uid(), groupId: state.groups[2].id, name:'Aã•ã‚“', amount:350}];
      state.shortage = state.total - groupsRoundedSum();
      console.assert(state.shortage === 300, 'UIå‰æ: 300ä¸è¶³');
      // çµæœã‚¿ãƒ–ã¸ï¼ˆç¢ºå®šï¼‰
      commitManualAndRebalance();
      // ãƒ©ã‚¦ãƒ³ãƒ‰è¿”é‡‘ãŒå…¥ã£ã¦ perPerson ãŒä¸‹ãŒã‚‹
      console.assert(state.groups[0].perPerson === 2100, 'UI: éƒ¨é•·2100');
      console.assert(state.groups[2].perPerson === 1200, 'UI: ä¸€èˆ¬1200');
      // çµæœåˆè¨ˆã¯ 9700-400+350=9650 â†’ å·®é¡ -350
      const sum = groupsRoundedSum() + manualEffect();
      console.assert((sum - state.total) === -350, 'UI: å·®é¡ -350');
    })();

    // 11) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œè¨¼ï¼šä¸è¶³300 / Aã•ã‚“+350ï¼ˆmanualDraftï¼‰â†’ åˆè¨ˆ9100 / æ®‹ã‚Š550ä¸è¶³ï¼ˆå›ºå®šã‚‚å«ã‚å…¨å“¡ãƒ©ã‚¦ãƒ³ãƒ‰ï¼‰
    (function(){
      state.mode='payMore';
      state.groups = [
        {id:uid(), name:'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:1, perPerson:2200, fixed:false},
        {id:uid(), name:'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people:2, perPerson:1800, fixed:true},
        {id:uid(), name:'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people:3, perPerson:1300, fixed:false}
      ];
      state.total = 10000; // 9700 â†’ 300ä¸è¶³
      state.manual = []; state.manualDraft=[{id:uid(), groupId: state.groups[2].id, name:'Aã•ã‚“', amount:350}];
      state.shortage = state.total - groupsRoundedSum();
      const preview = computePreview({includeFixedInPreview:true});
      console.assert(preview.sumPreview === 9100, 'preview: åˆè¨ˆ9100');
      console.assert(preview.remain === 550, 'preview: æ®‹ã‚Š550ä¸è¶³');
    })();

  }
  catch(e){
    console.error('ãƒ†ã‚¹ãƒˆå¤±æ•—', e);
  }finally{
    // å¾©å…ƒ
    const s = JSON.parse(snapshot);
    state.total = s.total; state.mode = s.mode; state.balance = s.balance; state.groups = s.groups; state.manual = s.manual; state.manualDraft = s.manualDraft; state.shortage = s.shortage;
    recompute(); renderAll();
  }
}


// ======= INIT =======
recompute();
renderAll();
// ç°¡æ˜“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
setTimeout(runTests, 0);
</script>
</body>
</html>





