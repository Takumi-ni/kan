<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KanziPlus</title>
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7292628789812881" crossorigin="anonymous"></script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>KanziPlus å¤§äººæ•°å‘ã‘å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒª</title>
<meta name="description" content="KanziPlusã¯å¤§äººæ•°å‘ã‘ã®å‰²ã‚Šå‹˜ã‚¢ãƒ—ãƒªï¼ã‚µãƒ¼ã‚¯ãƒ«ã‚„ä¼šç¤¾ã®é£²ã¿ä¼šã§å¤§æ´»èºï¼">
<meta name="google-site-verification" content="eQuZ-6OPek2UkDdG_wErO68Hi_ycFQP9SAoEV657LNo" />
<link rel="canonical" href="https://kanziplus.jp/" />
<link rel="icon" href="/favicon.ico">

<!-- Google Analytics (GA4) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-EXN7VZYJFG"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){ dataLayer.push(arguments); }
  gtag('js', new Date());
  gtag('config', 'G-EXN7VZYJFG');
</script>

<!-- JSON-LD æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆOrganizationï¼‰ -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "KanziPlus",
  "url": "https://kanziplus.jp",
  "logo": "https://kanziplus.jp/images/kanziplus-icon.png"
}
</script>

<style>
  :root{
    --bg:#151a22;--card:#1b2029;--ink:#e9eaee;--muted:#b2b6bf;--accent:#f8d27a;--accent-2:#ffb455;--ok:#22c55e;--bad:#ef4444;--line:#2f3542;--pink-soft:#1f1a12;
    --radius:18px;--shadow:0 18px 40px rgba(0,0,0,.30);
  }
  *{box-sizing:border-box}
  html, body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI",sans-serif;background:radial-gradient(1200px 600px at 20% -10%, #1b2029 0%, rgba(27,32,41,0) 60%),linear-gradient(180deg,#151a22 0%, #0f131a 100%);color:var(--ink);font-size:17px;line-height:1.6}
  header{position:sticky;top:0;z-index:20;background:rgba(21,26,34,.55);backdrop-filter:saturate(160%) blur(10px);border-bottom:1px solid #232938}
  .wrap{max-width:420px;margin:0 auto;padding:16px}
  .brand{font-weight:900;letter-spacing:.8px;color:#ffe8a3;font-size:26px;text-align:center;text-shadow:0 2px 8px rgba(248,210,122,.25)}
  .tabs{display:flex;gap:18px;margin-top:10px;justify-content:center;padding-bottom:0}
  .tab{appearance:none;border:none;background:transparent;padding:12px 18px;font-weight:700;color:var(--muted);cursor:pointer;position:relative;font-size:16px}
  .tab.active{color:var(--ink)}
  .tab.active:after{content:"";position:absolute;left:12px;right:12px;bottom:-1px;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:3px}
  .grid{display:grid;gap:16px}
  .two{grid-template-columns:1fr}
  .card{background:var(--card);box-shadow:var(--shadow);border-radius:var(--radius);padding:16px;border:1px solid #262c39}
  .card-pink{background:linear-gradient(180deg, rgba(255,220,140,.06), rgba(255,220,140,.04));border:1px solid rgba(255,220,140,.18)}
  .card h3{margin:0 0 10px 0;font-size:18px}
  label{font-size:14px;color:var(--muted)}
  input[type="text"],input[type="number"],select{width:100%;padding:12px 12px;border:1px solid #343a48;border-radius:12px;background:#12161e;color:var(--ink);font-size:16px}
  input[type="number"]{text-align:right}
  .row{display:flex;gap:10px;align-items:center}
  .row > *{flex:1}
  .row-inline{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:nowrap}
  .btn{appearance:none;border:none;border-radius:12px;padding:10px 14px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#271b05;font-weight:800;cursor:pointer;box-shadow:0 10px 26px rgba(255,180,85,.22)}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid var(--line);box-shadow:none}
  .btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
  .btn.bad{background:var(--bad)}
  .btn.ok{background:var(--ok)}
  .btn.accent{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#2a1b04}
  .btn.outline-pink{background:transparent;color:var(--accent);border:1.75px solid var(--accent);box-shadow:none}
  .btn.light-pink{background:#F0FFF7;color:#0b604a;border:1px solid #CFEFE3;box-shadow:none}
  .btn.lock-on{background:#e5e7eb;color:#374151;border:1px solid #d1d5db}
  .btn.lock-off{background:#fde68a;color:#7a5d00;border:1px solid #fcd34d}
  .toolbar{display:flex;gap:10px;flex-wrap:nowrap}
  .pill{padding:10px 18px;border:1px solid #343a48;border-radius:999px;background:#12161e;cursor:pointer;color:var(--muted);font-weight:700;flex:1;text-align:center}
  .pill.active{border-color:var(--accent);color:#ffe8a3;background:rgba(248,210,122,.10)}
  .muted{color:var(--muted)}
  .group-row{display:grid;grid-template-columns:1.6fr .7fr auto;gap:10px;align-items:center;margin-top:10px}
  .group-row .del{width:40px;height:48px;display:flex;align-items:center;justify-content:center}
  .name-cell{display:flex;align-items:center;gap:8px}
  .medal{font-size:18px;opacity:.9}
  .mini{font-size:13px;color:var(--muted)}
  hr.sep{border:none;border-top:1px dashed var(--line);margin:12px 0}
  .bars{display:flex;gap:8px;align-items:flex-end;justify-content:center;height:140px;padding:4px 2px;margin-top:14px}
  .bar{width:12px;border-radius:10px;box-shadow:inset 0 -4px 8px rgba(0,0,0,.08)}
  .hint{font-size:12px;color:var(--muted)}
  .money{font-variant-numeric:tabular-nums}
  .stack{display:flex;flex-direction:column;gap:8px}
  .controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .controls-wrap{display:flex;gap:8px;align-items:stretch;margin-top:8px}
  .btns4{display:grid;grid-template-columns:1fr 1fr;gap:8px;flex:1}
  .lock-pill{width:56px;border:1.5px solid var(--accent);border-radius:12px;background:transparent;color:#ffe8a3;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:0;line-height:.9}
  .lock-pill .mini{line-height:.85}
  .lock-pill .mini:first-of-type{display:inline-block;margin-top:2px}
  .fixed-banner{border:1.8px solid var(--accent);border-radius:12px;padding:10px 14px;text-align:center;color:#ffe8a3}
  .sumline{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:#181e28;border:1px solid #343a48}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);opacity:0;pointer-events:none;transition:opacity .25s}
  .toast.show{opacity:1}
  .result-card{background:radial-gradient(120% 80% at 50% 0%, rgba(248,210,122,.10), rgba(30,26,18,.92) 60%), #1b1810;border:1px solid rgba(248,210,122,.38);box-shadow:inset 0 10px 28px rgba(248,210,122,.10), 0 6px 18px rgba(0,0,0,.25)}
  .k-table{width:100%;border-collapse:collapse}
  .k-table td{padding:6px 0;border-bottom:1px solid #343a48}
  header .wrap{position:relative;padding:10px 16px 0}
  .brand-icon{font-size:28px; margin:0 8px; filter:drop-shadow(0 2px 6px rgba(248,210,122,.35))}
  .sky{position:absolute; inset:0; pointer-events:none}
  .star{position:absolute; width:3px; height:3px; background:#ffe8a3; border-radius:50%; opacity:.85; animation:twinkle 3s ease-in-out infinite}
  @keyframes twinkle{ 0%,100%{opacity:.4; transform:scale(.9)} 50%{opacity:1; transform:scale(1)} }
  input[type="number"]::-webkit-outer-spin-button,
  input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
  input[type="number"]{ -moz-appearance:textfield; }
  .big-num{ font-size:24px; }
  .help-icon{width:22px;height:22px;border-radius:50%;border:1px solid #3a4050;background:transparent;color:#aeb4bf;display:inline-flex;align-items:center;justify-content:center;font-weight:800;font-size:12px;margin-left:8px}
  .result-card h3{color:#ffe8a3;text-shadow:0 2px 6px rgba(248,210,122,.20)}
  .result-card .sumline{border-color:rgba(248,210,122,.35);background:rgba(248,210,122,.06)}

  /* ====== Mobile fixes (<=420px) ====== */
  @media (max-width: 420px){
    /* 1) ã€ŒãŠä¼šè¨ˆã®ç·é¡ã‚’å…¥åŠ›ã€ã‚’1è¡Œã«åã‚ã‚‹ */
    .row-inline{ gap:8px; }
    .row-inline h3{ white-space:nowrap; font-size:16px; } /* è¦‹å‡ºã—ã¯æŠ˜ã‚Šè¿”ã•ãªã„ */
    .row-inline .row{ flex:0 0 40%; max-width:160px; }     /* é‡‘é¡å…¥åŠ›ã®æ¨ªå¹…ã‚’ç¸®å° */
    .row-inline .mini{ white-space:nowrap; }               /* ã€Œå††ã€ã‚‚æŠ˜ã‚Šè¿”ã•ãªã„ */

    /* 2) ã‚°ãƒ«ãƒ¼ãƒ—äººæ•°ã‚»ãƒ¬ã‚¯ãƒˆã®ç¸¦å¹…ã‚’ä»–ã¨åˆã‚ã›ã‚‹ï¼ˆ48pxï¼‰ */
    .group-row select{
      height:48px;           /* æ—¢å­˜ã®ãƒ†ã‚­ã‚¹ãƒˆæ¬„/Ã—ãƒœã‚¿ãƒ³ã«åˆã‚ã›ã‚‹ */
      min-height:48px;
      padding:0 12px;
      line-height:48px;      /* iOSã§ã‚‚é«˜ã•ãŒè©°ã¾ã‚‰ãªã„ã‚ˆã†ã« */
    }

    /* è¿½åŠ ï¼šç«¯æ•°ã®å‰²ã‚ŠæŒ¯ã‚Šå†…ã®ã€Œã‚°ãƒ«ãƒ¼ãƒ—åã‚»ãƒ¬ã‚¯ãƒˆã€ã‚’å€‹äººåã®ç¸¦å¹…ã«åˆã‚ã›ã‚‹ */
    #manualList .gsel{
      height:48px;
      min-height:48px;
      line-height:48px;
    }

    /* 3) çµæœå‡ºåŠ›ã®å·®é¡è¡Œã‚’å¿…ãš1è¡Œã« */
    .result-card .sumline{ gap:8px; }
    .result-card .sumline .muted,
    .result-card #deltaLine{ white-space:nowrap; font-size:14px; }
  }
</style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="brand"><span class="brand-icon" aria-hidden="true">ğŸº</span>KanziPlus<span class="brand-icon" aria-hidden="true">âœ¨</span></div>
      <div class="sky" aria-hidden="true">
        <span class="star" style="top:6px;left:6%;width:4px;height:4px"></span>
        <span class="star" style="top:18px;left:20%;width:3px;height:3px"></span>
        <span class="star" style="top:10px;left:64%;width:5px;height:5px"></span>
        <span class="star" style="top:26px;left:82%;width:3px;height:3px"></span>
        <span class="star" style="top:30px;left:38%;width:4px;height:4px"></span>
        <span class="star" style="top:14px;left:50%;width:6px;height:6px"></span>
        <span class="star" style="top:4px;left:90%;width:5px;height:5px"></span>
      </div>
      <div class="tabs">
        <button class="tab active" data-tab="input" type="button">æƒ…å ±å…¥åŠ›</button>
        <button class="tab" data-tab="assign" type="button">å‰²ã‚ŠæŒ¯ã‚Š</button>
        <button class="tab" data-tab="result" type="button">çµæœå‡ºåŠ›</button>
      </div>
    </div>
  </header>

  <main class="wrap" style="padding-top:14px;padding-bottom:120px;">
    <!-- æƒ…å ±å…¥åŠ› TAB -->
    <section id="tab-input" class="grid two">
      <div class="card">
        <div class="row-inline">
          <h3 style="margin:0">ãŠä¼šè¨ˆã®ç·é¡ã‚’å…¥åŠ›</h3>
          <div class="row" style="flex:0 0 48%;gap:8px;align-items:center">
            <input id="totalInput" type="number" min="0" step="1" value="10000"/>
            <div class="mini" style="flex:none">å††</div>
          </div>
        </div>
      </div>

      <div class="card" style="grid-column:1 / -1;">
        <h3>ãŠæ”¯æ‰•ã„ã‚°ãƒ«ãƒ¼ãƒ—åã‚’å…¥åŠ›</h3>
        <div class="mini" style="margin:6px 0 8px;">ä¸Šã®ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰å¤šãæ‰•ã„ã¾ã™</div>
        <div id="groupsArea"></div>
        <div class="row" style="margin-top:6px">
          <button id="addGroup" class="btn outline-pink" style="width:100%" type="button">ï¼‹ ã‚°ãƒ«ãƒ¼ãƒ—ã‚’è¿½åŠ </button>
        </div>
      </div>

      <!-- å‰²ã‚Šå‹˜ãƒãƒ©ãƒ³ã‚¹ã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="grid-column:1 / -1;">
        <h3 style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <span>ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨ã®å‰²ã‚Šå‹˜ãƒãƒ©ãƒ³ã‚¹</span>
          <button id="balanceHelpBtn" class="help-icon" type="button">?</button>
        </h3>
        <div class="toolbar" id="balanceBtns">
          <button class="pill" data-balance="large" type="button">å¤§ãã„</button>
          <button class="pill active" data-balance="medium" type="button">æ™®é€š</button>
          <button class="pill" data-balance="small" type="button">å°ã•ã„</button>
        </div>
        <div class="bars" id="bars"></div>
        <div id="balanceHelpText" class="mini" style="display:none;margin-top:6px">
          ã‚°ãƒ«ãƒ¼ãƒ—é–“ã®1äººå½“ãŸã‚Šã®æ”¯æ‰•ã„ã®å·®é¡ã®å¤§ãã•ã‚’é¸ã³ã¾ã™<br/>
          åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®ãƒ¡ãƒ³ãƒãƒ¼ã®é‡‘é¡ã¯åŒã˜ã§ã™
        </div>
      </div>

      <!-- ç«¯æ•°ã®æ‰±ã„ã‚«ãƒ¼ãƒ‰ -->
      <div class="card" style="grid-column:1 / -1;">
        <h3>ç«¯æ•°ã®æ‰±ã„ã‚’ã©ã†ã™ã‚‹ï¼Ÿ</h3>
        <div class="toolbar" id="modeBtns">
          <button class="pill active" data-mode="payMore" type="button">èª°ã‹ãŒå¤šãæ‰•ã†</button>
          <button class="pill" data-mode="payLess" type="button">èª°ã‹ã‚’å®‰ãã™ã‚‹</button>
        </div>
      </div>

      <!-- æ¬¡ã¸é€²ã‚€ï¼ˆåˆ†é›¢ï¼‰ -->
      <div style="grid-column:1 / -1;" class="row">
        <button class="btn accent" onclick="goTab('assign')" style="width:100%" type="button">ã¤ãã¸é€²ã‚€</button>
      </div>
    </section>

    <!-- å‰²ã‚ŠæŒ¯ã‚Š TAB -->
    <section id="tab-assign" style="display:none" class="grid">
      <div class="card">
        <h3 style="margin-bottom:4px">æ”¯æ‰•ã„ã®é‡‘é¡ã‚’èª¿æ•´ã™ã‚‹</h3>
        <div class="mini">ï¼ˆ1äººã‚ãŸã‚Šã®é‡‘é¡ã‚’100å††å˜ä½ã§èª¿æ•´ã™ã‚‹ï¼‰</div>
        <div id="adjustArea" class="stack"></div>
        <div class="plain-sum" style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
          <div>åˆè¨ˆï¼ˆç«¯æ•°ã‚’é™¤ã„ãŸåˆè¨ˆï¼‰</div>
          <div><b id="sumRounded" class="money"></b> å††</div>
        </div>
      </div>

      <div class="card">
        <h3>ç«¯æ•°ã®å‰²ã‚ŠæŒ¯ã‚Š</h3>
        <div id="shortageLine" class="money" style="margin-bottom:8px"></div>
        <div id="manualList" class="stack"></div>
        <div class="row" style="margin-top:6px">
          <button id="addPerson" class="btn outline-pink" style="width:100%" type="button">ï¼‹ äººã‚’è¿½åŠ </button>
        </div>
      </div>

      <!-- æ¬¡ã¸é€²ã‚€ï¼ˆåˆ†é›¢ï¼‰ -->
      <div style="grid-column:1 / -1;" class="row">
        <button class="btn accent" onclick="goTab('result')" style="width:100%" type="button">ã¤ãã¸é€²ã‚€</button>
      </div>
    </section>

    <!-- çµæœå‡ºåŠ› TAB -->
    <section id="tab-result" style="display:none" class="grid">
      <div class="card result-card">
        <h3>çµæœ</h3>
        <div id="resultView" class="stack"></div>
        <div class="sumline" style="margin-top:10px">
          <div class="muted">ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š</div>
          <div id="deltaLine" class="money"></div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="btn outline-pink" id="copyBtn" style="width:100%" type="button">çµæœã‚’ã‚³ãƒ”ãƒ¼</button>
        </div>
      </div>

      <div class="row" style="grid-column:1 / -1;">
        <button id="toggleDetail" class="btn outline-pink" style="width:100%" type="button">è¨ˆç®—è©³ç´°</button>
      </div>
      <div id="detailCard" class="card" style="display:none">
        <h3>è¨ˆç®—è©³ç´°</h3>
        <div id="detailView" class="stack"></div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast"></div>

<script>
// ======= STATE =======
const state = {
  total: 10000,
  mode: 'payMore', // payMore: ä¸è¶³ã‚’æ®‹ã™ / payLess: è¶…éã‚’æ®‹ã™
  balance: 'medium',
  groups: [
    {id: uid(), name: 'éƒ¨é•·ã‚°ãƒ«ãƒ¼ãƒ—', people: 1, perPerson: 0, fixed:false},
    {id: uid(), name: 'èª²é•·ã‚°ãƒ«ãƒ¼ãƒ—', people: 2, perPerson: 0, fixed:false},
    {id: uid(), name: 'ä¸€èˆ¬ç¤¾å“¡ã‚°ãƒ«ãƒ¼ãƒ—', people: 3, perPerson: 0, fixed:false},
  ],
  manual: [], // {id, groupId, name, amount}
  manualDraft: [], // UIç”¨ã®ä¸‹æ›¸ã
  shortage: 0 // +ä¸è¶³, -è¶…é
}

// ======= UTIL =======
function uid(){ return Math.random().toString(36).slice(2,9) }
function yen(n){ return (Math.round(n)).toLocaleString('ja-JP') }
function round100(x, dir){ const m = Math.floor(x/100)*100; if(dir==='down') return m; if(dir==='up') return (x%100===0)? x : m+100; return Math.round(x/100)*100 }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600) }

// ======= TABS =======
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.tab');
  if (!btn) return;
  e.preventDefault();
  const dest = btn.dataset.tab;
  if (dest) goTab(dest);
});

function commitManualAndRebalance(){
  state.manual = JSON.parse(JSON.stringify(state.manualDraft||[]));
  state.shortage = state.total - groupsRoundedSum();
  tryRebalanceManual(-1);
}

function goTab(key){
  if(key==='result'){
    commitManualAndRebalance();
  }
  document.querySelectorAll('section[id^=tab-]').forEach(s=>s.style.display='none');
  const sec = document.getElementById('tab-'+key);
  if(sec) sec.style.display='grid';
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===key));
  renderAll();
}

// ======= INPUT: GROUPS UI =======
const groupsArea = document.getElementById('groupsArea');
const addGroupBtn = document.getElementById('addGroup');
addGroupBtn.addEventListener('click',()=>{
  state.groups.push({id:uid(), name:`ã‚°ãƒ«ãƒ¼ãƒ—${state.groups.length+1}`, people:1, perPerson:0, fixed:false});
  recompute(); renderAll();
});

function medalByIndex(i){ return ''; }

function renderGroupsEditor(){
  groupsArea.innerHTML = '';
  state.groups.forEach((g,idx)=>{
    const row = document.createElement('div');
    row.className='group-row';
    const medal = medalByIndex(idx);
    row.innerHTML = `
      <div class="name-cell">${medal?`<span class="medal">${medal}</span>`:''}<input type="text" value="${g.name}" data-k="name" placeholder="ã‚°ãƒ«ãƒ¼ãƒ—å"/></div>
      <select data-k="people">${Array.from({length:99},(_,i)=>`<option ${g.people===(i+1)?'selected':''} value="${i+1}">${i+1}äºº</option>`).join('')}</select>
      <button class="btn small ghost del" type="button">Ã—</button>`;
    row.querySelector('[data-k=name]').addEventListener('input',e=>{ g.name=e.target.value; });
    row.querySelector('[data-k=name]').addEventListener('blur',()=>{ renderAll(); });
    row.querySelector('[data-k=people]').addEventListener('change',e=>{ g.people=parseInt(e.target.value); recompute(); renderAll() });
    row.querySelector('.del').addEventListener('click',()=>{ if(state.groups.length<=1){ toast('ã‚°ãƒ«ãƒ¼ãƒ—ã¯æœ€ä½1ã¤å¿…è¦ã§ã™'); return } state.groups.splice(idx,1); recompute(); renderAll(); });
    groupsArea.appendChild(row);
  });
}

// ======= INPUT: TOTAL & MODE & BALANCE =======
const totalInput = document.getElementById('totalInput');
const balanceBtns = document.getElementById('balanceBtns');
const modeBtns = document.getElementById('modeBtns');
const helpBtn = document.getElementById('balanceHelpBtn');
const helpText = document.getElementById('balanceHelpText');
if(helpBtn){ helpBtn.addEventListener('click',()=>{ helpText.style.display = helpText.style.display==='none'?'block':'none'; }); }

totalInput.addEventListener('input',()=>{ state.total= Number(totalInput.value||0); recompute(); renderAll(); });
;['large','medium','small'].forEach(x=>{
  const p = balanceBtns.querySelector(`[data-balance=${x}]`);
  p.addEventListener('click',()=>{ balanceBtns.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); p.classList.add('active'); state.balance=x; recompute(); renderAll(); })
});
;['payMore','payLess'].forEach(m=>{
  const b = modeBtns.querySelector(`[data-mode=${m}]`);
  b.addEventListener('click',()=>{ modeBtns.querySelectorAll('.pill').forEach(x=>x.classList.remove('active')); b.classList.add('active'); state.mode=m; recompute(); renderAll(); })
});

// ======= BALANCE BARS =======
function weightsByBalance(n){
  if(state.balance==='large'){ return Array.from({length:n},(_,i)=> (n-i)); } 
  else if(state.balance==='small'){ const base=1; const step=0.1; return Array.from({length:n},(_,i)=> base + step*(n-1-i)); } 
  else { const base=1; const step=0.3; return Array.from({length:n},(_,i)=> base + step*(n-1-i)); }
}
function renderBars(ws){
  const bars = document.getElementById('bars');
  const max = Math.max(...ws,1);
  bars.innerHTML = ws.map((w,i)=>{
    const h = 30 + (w/max)*88;
    const colors = ['#D4AF37','#C0C0C0','#CD7F32'];
    const color = i<3 ? colors[i] : '#d1d5db';
    return `<div class="bar" title="é‡ã¿ ${w.toFixed(2)}" style="height:${h}px;background:${color}"></div>`
  }).join('');
}

// ======= CORE CALCï¼ˆãƒãƒŸãƒ«ãƒˆãƒ³æ³•ï¼‹ç«¯æ•°ãƒãƒªã‚·ãƒ¼å³å®ˆï¼‰ =======
function recompute(){
  const U = 100;
  const ws = weightsByBalance(state.groups.length);

  state.groups.forEach(g => { if (g._bump == null) g._bump = 0; });

  let fixedSum = 0;
  const tempFixed = new Set();
  state.groups.forEach((g) => { if (g.fixed) fixedSum += (g.perPerson||0)*(g.people||0); });
  state.groups.forEach((g,i) => {
    if (g._bump !== 0) {
      const newPP = Math.max(0,(g.perPerson||0)+g._bump);
      g.perPerson = newPP; fixedSum += newPP*(g.people||0); tempFixed.add(i);
    }
  });

  const remain = state.total - fixedSum;
  let unitSum = 0;
  state.groups.forEach((g,i)=>{ if(!(g.fixed||tempFixed.has(i))) unitSum += (g.people||0)*(ws[i]||0); });
  const x = unitSum>0 ? remain/unitSum : 0;

  const raws = [];
  state.groups.forEach((g,i)=>{
    if (g.fixed || tempFixed.has(i)) { raws[i] = g.perPerson||0; }
    else {
      const raw = (ws[i]||0)*x; raws[i]=raw;
      g.perPerson = Math.max(0, Math.round(raw/U)*U);
    }
  });

  let sum0 = 0; state.groups.forEach(g=> sum0 += (g.perPerson||0)*(g.people||0));
  let diff = state.total - sum0;

  const adjustableIdx = () => state.groups.map((g,i)=>({g,i}))
    .filter(o => !(o.g.fixed||tempFixed.has(o.i)) && (o.g.people||0)>0);
  const scoreOf = (i, sign) => sign>0 ? ((raws[i]||0)-(state.groups[i].perPerson||0))
                                      : ((state.groups[i].perPerson||0)-(raws[i]||0));

  function stepOnce(sign){
    const cand = adjustableIdx()
      .filter(o => sign>0 ? true : (o.g.perPerson||0) >= U)
      .map(o => ({i:o.i,g:o.g,score:scoreOf(o.i,sign)}))
      .sort((a,b)=>{
        if (b.score!==a.score) return b.score-a.score;
        const byCnt=(b.g.people||0)-(a.g.people||0); if (byCnt) return byCnt;
        const byW=(ws[b.i]||0)-(ws[a.i]||0); if (byW) return byW;
        return a.i-b.i;
      });
    for(const c of cand){
      const step = sign>0 ? +U : -U;
      const newP = (c.g.perPerson||0)+step; if(newP<0) continue;
      const newDiff = diff - step*(c.g.people||0);
      if (Math.abs(newDiff) < Math.abs(diff)) {
        c.g.perPerson=newP; diff=newDiff; return true;
      }
    }
    return false;
  }

  let guard=0;
  while(Math.abs(diff)>=U){
    const moved = stepOnce(diff>0?+1:-1);
    if(!moved||++guard>4000) break;
  }

  function enforceSign(){
    if (state.mode==='payMore' && diff<0){
      const cand = adjustableIdx()
        .filter(o => (o.g.perPerson||0) >= U)
        .map(o => {
          const nd = diff + U*(o.g.people||0);
          return {i:o.i,g:o.g,newDiff:nd,incAbs:Math.abs(nd)};
        })
        .sort((a,b)=>{
          if(a.incAbs!==b.incAbs) return a.incAbs-b.incAbs;
          const byCnt=(a.g.people||0)-(b.g.people||0); if(byCnt) return byCnt;
          const byW=(ws[a.i]||0)-(ws[b.i]||0); if(byW) return byW;
          return a.i-b.i;
        });
      if(cand.length){
        cand[0].g.perPerson -= U; diff = cand[0].newDiff;
        if(diff<0) enforceSign();
      }
    }
    if (state.mode==='payLess' && diff>0){
      const cand = adjustableIdx()
        .map(o => {
          const nd = diff - U*(o.g.people||0);
          return {i:o.i,g:o.g,newDiff:nd,incAbs:Math.abs(nd)};
        })
        .sort((a,b)=>{
          if(a.incAbs!==b.incAbs) return a.incAbs-b.incAbs;
          const byCnt=(a.g.people||0)-(b.g.people||0); if(byCnt) return byCnt;
          const byW=(ws[a.i]||0)-(ws[b.i]||0); if(byW) return byW;
          return a.i-b.i;
        });
      if(cand.length){
        cand[0].g.perPerson += U; diff = cand[0].newDiff;
        if(diff>0) enforceSign();
      }
    }
  }
  enforceSign();

  state.groups.forEach(g=>{ g._bump = 0; });
  state.shortage = diff;
}

function groupsRoundedSum(){ return state.groups.reduce((s,g)=> s + (g.perPerson||0) * (g.people||0), 0); }

// ======= Â±ãƒœã‚¿ãƒ³ï¼šæŠ¼ã—ãŸã‚°ãƒ«ãƒ¼ãƒ—ã ã‘å³å¯†Â±ã—ã€ä»–ã¯å†ãƒãƒŸãƒ«ãƒˆãƒ³ =======
function clickAdjust(idx, step){
  if (step === 0) return;
  const g = state.groups[idx]; if (!g) return;
  if (g._bump == null) g._bump = 0;
  g._bump += step;
  recompute();
  renderAll();
}

// ======= äº’æ›APIï¼šæ—§ãƒ­ã‚¸ãƒƒã‚¯ã®å‘¼ã³å‡ºã—å£ã‚’å†è¨ˆç®—ã«å§”è­² =======
function autoDistribute(){ recompute(); return true; }
function tryRebalanceManual(){ recompute(); return true; }

// ======= ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼šç¾åœ¨ã® perPerson ã‚’ãƒ™ãƒ¼ã‚¹ã«æ¦‚ç®—ã‚’è¿”ã™ =======
function computePreview(){
  const per = state.groups.map(g => g.perPerson||0);
  const sumPreview = per.reduce((s,p,i)=> s + p*(state.groups[i].people||0), 0);
  const draft = state.manualDraft || [];
  const draftSum = draft.reduce((acc,m)=> acc + (Number(m.amount)||0), 0);
  const draftEffect = (state.mode==='payMore') ? draftSum : -draftSum; // ç«¯æ•°ã®å¢—æ¸›ã‚’åæ˜ 
  const remain = state.total - (sumPreview + draftEffect);            // +ä¸è¶³ / -è¶…é
  return { per, remain, sumPreview, draftSum };
}

// ======= ASSIGN TAB RENDER =======
const adjustArea = document.getElementById('adjustArea');
const sumRoundedEl = document.getElementById('sumRounded');
const shortageLine = document.getElementById('shortageLine');

function renderAssign(){
  adjustArea.innerHTML='';
  const hasDraft = (state.manualDraft||[]).length>0 && (state.manualDraft||[]).some(m=>Number(m.amount)>0);
  const preview = computePreview();

  state.groups.forEach((g,idx)=>{
    const row = document.createElement('div');
    row.className='card card-pink';
    const displayPer = hasDraft ? preview.per[idx] : g.perPerson;
    row.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:flex-end">
        <div>
          <div style="font-weight:800">${g.name}</div>
          <div class="mini muted">${g.people}äºº</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:22px;font-weight:800" class="money">${yen(displayPer)}å††<span class="mini">/1äºº</span></div>
        </div>
      </div>
      ${g.fixed ? `
        <div class="fixed-banner">ğŸ”’ é‡‘é¡å›ºå®šä¸­</div>
      ` : `
        <div class="controls-wrap">
          <div class="btns4">
            <button class="btn small outline-pink" data-d="+100" type="button">ï¼‹100</button>
            <button class="btn small outline-pink" data-d="-100" type="button">âˆ’100</button>
            <button class="btn small outline-pink" data-d="+1000" type="button">ï¼‹1000</button>
            <button class="btn small outline-pink" data-d="-1000" type="button">âˆ’1000</button>
          </div>
          <button class="lock-pill" data-lock="1" type="button">ğŸ”“<br><span class="mini">å›ºå®š</span><br><span class="mini">ãªã—</span></button>
        </div>
      `}`;

    row.querySelectorAll('button[data-d]')?.forEach(b=> b.addEventListener('click',()=>{ clickAdjust(idx, parseInt(b.dataset.d,10)); }));
    const lockBtn = row.querySelector('[data-lock]');
    if(lockBtn){ lockBtn.addEventListener('click', ()=>{ g.fixed = true; renderAll(); }); }
    if(g.fixed){
      const banner = row.querySelector('.fixed-banner');
      banner.addEventListener('click',()=>{ g.fixed=false; renderAll(); });
    }

    adjustArea.appendChild(row);
  });

  const sumForView = hasDraft ? preview.sumPreview : groupsRoundedSum();
  sumRoundedEl.textContent = yen(sumForView);

  const remain = hasDraft ? preview.remain : state.shortage; // +ä¸è¶³ / -è¶…é
  const absRemain = Math.abs(remain);
  shortageLine.innerHTML = absRemain===0
    ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
    : (remain<0
        ? `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain)}</b> å†† å¤šã„ã§ã™`
        : `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain)}</b> å†† å®‰ã„ã§ã™`);

  const addBtn = document.getElementById('addPerson');
  if(addBtn){ addBtn.textContent = state.mode==='payMore' ? 'ï¼‹ å¤šãæ”¯æ‰•ã†äººã‚’è¿½åŠ ' : 'ï¼‹ å®‰ãã™ã‚‹äººã‚’è¿½åŠ '; }

  renderManualList();
}

function updateShortagePreview(){
  const hasDraft = (state.manualDraft||[]).some(m=>Number(m.amount)>0);
  if(!hasDraft){
    sumRoundedEl.textContent = yen(groupsRoundedSum());
    const absRemain0 = Math.abs(state.shortage);
    const r0 = state.shortage;
    shortageLine.innerHTML = absRemain0===0
      ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
      : (r0<0
          ? `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain0)}</b> å†† å¤šã„ã§ã™`
          : `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain0)}</b> å†† å®‰ã„ã§ã™`);
    return;
  }
  const preview = computePreview();
  const cards = adjustArea.querySelectorAll('.card.card-pink');
  cards.forEach((card, i)=>{
    const moneyEl = card.querySelector('.money');
    if(moneyEl && preview.per[i] != null){ moneyEl.innerHTML = yen(preview.per[i]) + 'å††<span class="mini">/1äºº</span>'; }
  });
  sumRoundedEl.textContent = yen(preview.sumPreview);
  const absRemain = Math.abs(preview.remain);
  const r = preview.remain;
  shortageLine.innerHTML = absRemain===0
    ? '<b>ãƒ”ãƒƒã‚¿ãƒªã§ã™</b>'
    : (r<0
        ? `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain)}</b> å†† å¤šã„ã§ã™`
        : `ãŠä¼šè¨ˆã®ç·é¡ã‚ˆã‚Š <b class="money big-num">${yen(absRemain)}</b> å†† å®‰ã„ã§ã™`);
}

// ======= MANUAL ASSIGN =======
const manualList = document.getElementById('manualList');
const addPersonBtn = document.getElementById('addPerson');
addPersonBtn.addEventListener('click',()=>{
  if(state.groups.length===0) return;
  state.manualDraft.push({id:uid(), groupId:state.groups[0].id, name:'', amount:0});
  renderManualList();
  updateShortagePreview();
});

function renderManualList(){
  manualList.innerHTML='';
  const tail = state.mode==='payMore' ? 'å†† å¤šãæ‰•ã†' : 'å†† å®‰ãã™ã‚‹';
  (state.manualDraft||[]).forEach((m,i)=>{
    const box = document.createElement('div');
    box.className='card card-pink';
    const options = state.groups.map(g=>`<option value="${g.id}" ${g.id===m.groupId?'selected':''}>${g.name}</option>`).join('');
    box.innerHTML = `
      <div class="row" style="gap:8px">
        <select class="gsel">${options}</select>
        <input class="name" type="text" placeholder="ãŠåå‰" value="${m.name}"/>
      </div>
      <div class="row" style="margin-top:8px">
        <input class="amt" type="number" min="0" step="1" inputmode="numeric" value="${m.amount}"/>
        <div class="mini" style="flex:none">${tail}</div>
        <button class="btn small ghost" style="flex:none" type="button">Ã—</button>
      </div>`;

    box.querySelector('.gsel').addEventListener('change',e=>{ m.groupId = e.target.value; updateShortagePreview(); renderManualList(); });
    box.querySelector('.name').addEventListener('input',e=>{ m.name = e.target.value; updateShortagePreview(); });
    box.querySelector('.amt').addEventListener('input',e=>{ m.amount = Number(e.target.value||0); updateShortagePreview(); });

    box.querySelector('button').addEventListener('click',()=>{ state.manualDraft.splice(i,1); renderManualList(); updateShortagePreview(); });

    manualList.appendChild(box);
  });
}

function manualEffect(){
  const s = state.manual.reduce((acc,m)=> acc + (m.amount||0), 0);
  return (state.mode==='payMore') ? s : -s;
}

// ======= RESULT RENDER =======
const resultView = document.getElementById('resultView');
const deltaLine = document.getElementById('deltaLine');
const detailView = document.getElementById('detailView');
const toggleDetailBtn = document.getElementById('toggleDetail');
const detailCard = document.getElementById('detailCard');
if(toggleDetailBtn){ toggleDetailBtn.addEventListener('click',()=>{ detailCard.style.display = detailCard.style.display==='none'?'block':'none'; }); }

function updateResults(){
  resultView.innerHTML=''; detailView.innerHTML='';
  const manualByGroup = {}; state.groups.forEach(g=> manualByGroup[g.id]=[]);
  state.manual.forEach(m=>{ if(manualByGroup[m.groupId]) manualByGroup[m.groupId].push({name:m.name||'ï¼ˆåå‰æœªå…¥åŠ›ï¼‰', amount:m.amount||0}); });

  let sum = 0;
  state.groups.forEach(g=>{
    const groupTotal = g.perPerson * g.people;
    const manualSum = manualByGroup[g.id].reduce((a,x)=>a+x.amount,0) * (state.mode==='payMore'? 1 : -1);
    sum += groupTotal + manualSum;

    const section = document.createElement('div');
    section.className='card card-pink';

    const hasManual = manualByGroup[g.id].length>0;
    const unit = hasManual ? '' : `<span class="mini">1äººã‚ãŸã‚Š</span> <b class="money">${yen(g.perPerson)}</b>å††`;

    let peopleBlock = '';
    if(hasManual){
      peopleBlock = manualByGroup[g.id].map(x=>{
        const adj = (state.mode==='payMore'? '+' : 'âˆ’') + yen(x.amount);
        const val = state.mode==='payMore'? (g.perPerson + x.amount) : (g.perPerson - x.amount);
        return `<div class="row" style="justify-content:space-between"><div>ãƒ»${x.name} <span class="mini">(${adj}å††)</span></div><div class="money">${yen(val)}å††</div></div>`
      }).join('');
      const others = g.people - manualByGroup[g.id].length;
      if(others>0){
        peopleBlock += `<div class="row" style="justify-content:space-between"><div>ãƒ»ä»–ãƒ¡ãƒ³ãƒãƒ¼ <span class="mini">(+0å††)</span></div><div class="money"><span class="mini">1äººã‚ãŸã‚Š</span> ${yen(g.perPerson)}å††</div></div>`
      }
    }

    section.innerHTML = `<div style="font-weight:800">${g.name}${unit?` <span style="margin-left:10px">${unit}</span>`:''}</div>${peopleBlock ? `<div class="stack" style="margin-top:6px">${peopleBlock}</div>`:''}`;
    resultView.appendChild(section);

    const d = document.createElement('div');
    let lines = `<table class="k-table">`+
      `<tr><td>${g.name}</td><td class="money" style="text-align:right">${yen(g.perPerson)}å†† Ã— ${g.people}äºº = ${yen(groupTotal)}å††</td></tr>`;
    manualByGroup[g.id].forEach(x=>{ const sign = state.mode==='payMore'? '+' : 'âˆ’'; lines += `<tr><td>${x.name}</td><td class="money" style="text-align:right">${sign}${yen(x.amount)}å††</td></tr>` });
    lines += `</table>`; d.innerHTML = lines; detailView.appendChild(d);
  });

  const delta = sum - state.total; // +å¤šã„ / -è¶³ã‚Šãªã„
  if(delta===0){ deltaLine.innerHTML = `<b class="ok">å·®é¡ 0 å††ï¼ˆãƒ”ãƒƒã‚¿ãƒªï¼‰</b>`; }
  else if(delta>0){ deltaLine.innerHTML = `<span class="money">${yen(Math.abs(delta))}</span> å†† <b>å¤šã„</b>`; }
  else { deltaLine.innerHTML = `<span class="money">${yen(Math.abs(delta))}</span> å†† <b>è¶³ã‚Šãªã„</b>`; }

  const totals = document.createElement('div');
  totals.innerHTML = `
    <hr class="sep"/>
    <table class="k-table">
      <tr><td>åˆè¨ˆ</td><td class="money" style="text-align:right">${yen(sum)}å††</td></tr>
      <tr><td>ãŠä¼šè¨ˆé‡‘é¡</td><td class="money" style="text-align:right">${yen(state.total)}å††</td></tr>
      <tr><td>å·®é¡</td><td class="money" style="text-align:right">${delta>0? '+' : ''}${yen(delta)}å††</td></tr>
    </table>`;
  detailView.appendChild(totals);

  window.__copyText = buildCopyText(sum, delta);
}

function buildCopyText(sum, delta){
  let t = `ã€KanziPlus è¨ˆç®—çµæœã€‘
åˆè¨ˆ: ${yen(state.total)} å††
`;
  state.groups.forEach(g=>{
    const entries = state.manual.filter(m=>m.groupId===g.id);
    if(entries.length>0){
      t += `â– ${g.name}
`;
      entries.forEach(x=>{
        const sign = state.mode==='payMore' ? '+' : 'âˆ’';
        const val = state.mode==='payMore' ? (g.perPerson + x.amount) : (g.perPerson - x.amount);
        t += `ãƒ»${x.name || 'ï¼ˆåå‰æœªå…¥åŠ›ï¼‰'} (${sign}${yen(x.amount)}å††) ${yen(val)}å††
`;
      });
      const others = g.people - entries.length;
      if(others>0){
        t += `ãƒ»ä»–ãƒ¡ãƒ³ãƒãƒ¼ (+0å††) 1äººã‚ãŸã‚Š ${yen(g.perPerson)}å††
`;
      }
    }else{
      t += `${g.name} 1äººã‚ãŸã‚Š ${yen(g.perPerson)}å††
`;
    }
  });
  t += `åˆè¨ˆ(${yen(sum)}å††) / å·®é¡(${delta>0? '+' : ''}${yen(delta)}å††${delta===0?'ãƒ»ãƒ”ãƒƒã‚¿ãƒª':''})`;
  return t;
}

// ======= COPY =======
document.getElementById('copyBtn').addEventListener('click',async()=>{
  try{ await navigator.clipboard.writeText(window.__copyText||''); toast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ'); }catch(e){ toast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
});

// ======= RENDER ALL =======
function renderAll(){
  totalInput.value = state.total;
  renderGroupsEditor(); const ws = weightsByBalance(state.groups.length); renderBars(ws);
  if(state.groups.every(g=>!g.perPerson)) recompute();
  renderAssign(); updateResults();
}

// ======= INIT =======
recompute();
renderAll();
</script>
</body>
</html>








